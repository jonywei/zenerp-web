{% extends 'base.html' %}
{% block title %}å¿«é€Ÿå…¥åº“{% endblock %}
{% block content %}
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-sm border border-gray-100 p-6 md:p-8">
    <div class="flex justify-between items-center mb-6 border-l-4 border-green-500 pl-3">
        <h2 class="text-xl font-bold text-gray-800">å•†å“å…¥åº“å­˜æ¡£</h2>
    </div>
    
    <form id="entryForm" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">ä¾›åº”å•†</label>
                <div class="flex gap-2">
                    <select id="supplier_id" class="flex-1 h-10 border rounded px-3 bg-white outline-none focus:ring-2 focus:ring-green-500">
                        <option value="0">ğŸ›’ æ•£å®¢ / æ— ä¾›åº”å•†</option>
                    </select>
                    <button type="button" onclick="showAddModal()" class="w-10 h-10 bg-green-100 text-green-700 rounded font-bold hover:bg-green-200 text-xl flex items-center justify-center">+</button>
                </div>
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">å•†å“åˆ†ç±» <span class="text-red-500">*</span></label>
                <select name="category" class="form-control h-10 border rounded px-3 w-full bg-white" id="category" onchange="handleCategoryChange()">
                    <option value="ZJ">ğŸ–¥ï¸ æ•´æœº (ç”µè„‘ä¸»æœº/ç¬”è®°æœ¬)</option>
                    <option value="XS">ğŸ“º æ˜¾ç¤ºå™¨</option>
                    <option value="SJ">ğŸ”© æ•£ä»¶/é…ä»¶</option>
                    <option value="PH">ğŸ“± æ‰‹æœº (Phone)</option>
                    <option value="TB">ğŸ“Ÿ å¹³æ¿ (Tablet)</option>
                    <option value="ZX">ğŸ“¦ æ‚é¡¹/å…¶ä»–</option>
                </select>
            </div>
        </div>

        <div class="bg-gray-50 p-4 rounded-xl border border-dashed border-gray-300 text-center relative group hover:border-green-400 transition cursor-pointer">
            <input type="file" id="imageFile" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="previewImage(this)">
            <div id="uploadTip" class="py-6">
                <p class="text-4xl mb-2">ğŸ“·</p>
                <p class="text-sm text-gray-500 font-bold">ç‚¹å‡»æ‹æ‘„/ä¸Šä¼ å•†å“å›¾ç‰‡</p>
            </div>
            <img id="imgPreview" class="hidden h-40 mx-auto rounded shadow-sm object-contain bg-white relative z-0">
        </div>

        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
            <label class="block text-sm font-bold text-yellow-800 mb-2">
                ğŸ”¢ åºåˆ—å· / IMEI / SNç  <span class="text-xs font-normal text-gray-500">(å”¯ä¸€èº«ä»½ID)</span>
            </label>
            <input type="text" id="sn" class="w-full h-12 border border-yellow-300 rounded px-3 text-lg font-mono tracking-wide focus:ring-2 focus:ring-yellow-500" placeholder="æ‰«ç æˆ–æ‰‹åŠ¨è¾“å…¥ (ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆ)">
        </div>

        <div id="computerConfig" class="bg-blue-50 p-5 rounded-lg border border-blue-100 transition-all duration-300">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-blue-200">
                <h3 class="text-sm font-bold text-blue-700" id="configTitle">ğŸ–¥ï¸ è¯¦ç»†é…ç½®å•</h3>
                <button type="button" onclick="autoGenerateName()" class="text-xs text-blue-600 bg-white px-2 py-1 rounded shadow-sm border border-blue-100 hover:bg-blue-50">
                    ç‚¹å‡»åˆ·æ–°åç§°ç”Ÿæˆ â†»
                </button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                    <label class="text-xs text-blue-600 font-bold block mb-1" id="lbl_cpu">CPU</label>
                    <input id="cpu" class="w-full h-9 border rounded px-2 text-sm" placeholder="i5-12400F" oninput="autoGenerateName()">
                </div>
                <div>
                    <label class="text-xs text-blue-600 font-bold block mb-1" id="lbl_ram">å†…å­˜</label>
                    <input id="ram" class="w-full h-9 border rounded px-2 text-sm" placeholder="16G" oninput="autoGenerateName()">
                </div>
                <div>
                    <label class="text-xs text-blue-600 font-bold block mb-1" id="lbl_disk">ç¡¬ç›˜</label>
                    <input id="disk" class="w-full h-9 border rounded px-2 text-sm" placeholder="512G" oninput="autoGenerateName()">
                </div>
                <div>
                    <label class="text-xs text-blue-600 font-bold block mb-1" id="lbl_gpu">æ˜¾å¡ (ç©º=æ ¸æ˜¾)</label>
                    <input id="gpu" class="w-full h-9 border rounded px-2 text-sm" placeholder="RTX3060" oninput="autoGenerateName()">
                </div>
            </div>
        </div>

        <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">å¤‡æ³¨ / æˆè‰²</label>
            <input id="note" class="w-full h-10 border rounded px-3" placeholder="ä¾‹å¦‚ï¼šæµ·æ™¯æˆ¿æœºç®± / 99æ–°" oninput="autoGenerateName()">
        </div>

        <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">å•†å“åç§° <span class="text-red-500">*</span></label>
            <input id="name" class="w-full h-10 border rounded px-3 focus:ring-2 focus:ring-green-500 font-bold text-gray-700 bg-gray-50" placeholder="å¡«å†™é…ç½®è‡ªåŠ¨ç”Ÿæˆ...">
        </div>

        <div class="bg-gray-50 p-5 rounded border border-gray-200 space-y-4">
            <div class="grid grid-cols-3 gap-4 border-b border-gray-200 pb-4">
                <div><label class="block text-xs font-bold text-gray-500 mb-1">å…¥åº“æˆæœ¬ <span class="text-red-500">*</span></label><input id="cost" type="number" class="w-full h-10 border rounded px-3 font-bold text-red-600 text-lg"></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">åŒè¡Œä»·</label><input id="peer_price" type="number" class="w-full h-10 border rounded px-3 font-bold text-blue-600" placeholder="0.00"></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">é›¶å”®ä»·</label><input id="retail_price" type="number" class="w-full h-10 border rounded px-3 font-bold text-green-600" placeholder="0.00"></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs font-bold text-gray-500 mb-1">å®ä»˜é‡‘é¢</label><input id="paid" type="number" class="w-full h-10 border rounded px-3 font-bold text-gray-800" value="0"></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">ä»˜æ¬¾è´¦æˆ·</label><select id="acc" class="w-full h-10 border rounded px-3 text-sm bg-white"><option value="">æœªä»˜ç•™ç©º...</option></select></div>
            </div>
        </div>

        <button type="button" onclick="submitForm()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 shadow-md text-lg">ç¡®è®¤å…¥åº“å­˜æ¡£</button>
    </form>
</div>

<div id="addModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center"><div class="bg-white p-6 rounded-lg w-80 shadow-xl"><input id="newCName" class="w-full border rounded h-10 px-3 mb-3" placeholder="åç§°"><input id="newCPhone" class="w-full border rounded h-10 px-3 mb-3" placeholder="ç”µè¯"><input id="newCAddr" class="w-full border rounded h-10 px-3 mb-4" placeholder="åœ°å€"><div class="flex justify-end gap-2"><button onclick="document.getElementById('addModal').classList.add('hidden')" class="px-4 py-2 bg-gray-100 rounded">å–æ¶ˆ</button><button onclick="addContact()" class="px-4 py-2 bg-green-600 text-white rounded">ä¿å­˜</button></div></div></div>
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center p-4"><div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden"><div class="bg-green-500 p-6 text-center"><h3 class="text-white font-bold text-xl">å…¥åº“æˆåŠŸ!</h3></div><div class="p-6 text-center space-y-4"><div><p class="text-xs text-gray-400">ZenCode</p><p class="text-3xl font-mono font-black text-gray-800" id="resZencode">--</p></div><div><p class="text-xs text-gray-400">å•†å“åç§°</p><p class="text-sm font-bold text-gray-700 mt-1" id="resName">--</p></div><button onclick="location.reload()" class="w-full bg-green-100 text-green-700 py-3 rounded-xl font-bold">ç»§ç»­å…¥åº“</button></div></div></div>

<script>
    async function init() {
        const [c, a] = await Promise.all([axios.get('/api/contacts/?page_size=1000'), axios.get('/api/analysis/accounting/')]);
        const sSelect = document.getElementById('supplier_id');
        (c.data.results || c.data).forEach(i => sSelect.innerHTML += `<option value="${i.id}">${i.name}</option>`);
        a.data.accounts.forEach(i => document.getElementById('acc').innerHTML += `<option value="${i.id}">${i.name}</option>`);
        handleCategoryChange();
    }
    init();

    function handleCategoryChange() {
        const cat = document.getElementById('category').value;
        const div = document.getElementById('computerConfig');
        const title = document.getElementById('configTitle');
        const snInput = document.getElementById('sn');
        
        if (cat === 'SJ' || cat === 'ZX') { div.classList.add('hidden'); } else { div.classList.remove('hidden'); }

        if (cat === 'PH' || cat === 'TB') {
            title.innerText = cat === 'PH' ? 'ğŸ“± æ‰‹æœºå‚æ•°å½•å…¥' : 'ğŸ“Ÿ å¹³æ¿å‚æ•°å½•å…¥';
            setLabels('å“ç‰Œ (Brand)', 'å¦‚: Apple / åä¸º', 'å‹å· (Model)', 'å¦‚: iPhone 15 / Mate 60', 'å®¹é‡/é…ç½®', 'å¦‚: 256G / 512G', 'é¢œè‰²/ç‰ˆæœ¬', 'å¦‚: é»‘è‰² / å›½è¡Œ');
            document.getElementById('note').placeholder = "ä¾‹å¦‚ï¼šç”µæ± 98% / å±å¹•æ— åˆ’ç—• / åœ¨ä¿";
            snInput.placeholder = "ğŸ“± è¯·æ‰«æ/è¾“å…¥ IMEI (å¿…å¡«)";
        } else if (cat === 'XS') {
            title.innerText = 'ğŸ“º æ˜¾ç¤ºå™¨å‚æ•°';
            setLabels('å“ç‰Œ', 'å¦‚: ä¸‰æ˜Ÿ / AOC', 'å°ºå¯¸', 'å¦‚: 27è‹±å¯¸', 'åˆ·æ–°ç‡', 'å¦‚: 144Hz', 'é¢æ¿/åˆ†è¾¨ç‡', 'å¦‚: IPS / 4K');
            document.getElementById('note').placeholder = "ä¾‹å¦‚ï¼šæ— åç‚¹ / æ”¯æ¶é½å…¨";
            snInput.placeholder = "ğŸ“º åºåˆ—å·/SN (å»ºè®®å¡«å†™)";
        } else {
            title.innerText = 'ğŸ–¥ï¸ è¯¦ç»†é…ç½®å•';
            setLabels('CPU', 'i5-12400F', 'å†…å­˜', '16G', 'ç¡¬ç›˜', '512G', 'æ˜¾å¡ (ç©º=æ ¸æ˜¾)', 'RTX3060');
            document.getElementById('note').placeholder = "ä¾‹å¦‚ï¼šæµ·æ™¯æˆ¿æœºç®± / 99æ–°";
            snInput.placeholder = "ğŸ–¥ï¸ æœºç®±ç¼–å·/SN (ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ)";
        }
        autoGenerateName();
    }

    function setLabels(l1, p1, l2, p2, l3, p3, l4, p4) {
        document.getElementById('lbl_cpu').innerText = l1; document.getElementById('cpu').placeholder = p1;
        document.getElementById('lbl_ram').innerText = l2; document.getElementById('ram').placeholder = p2;
        document.getElementById('lbl_disk').innerText = l3; document.getElementById('disk').placeholder = p3;
        document.getElementById('lbl_gpu').innerText = l4; document.getElementById('gpu').placeholder = p4;
    }

    function autoGenerateName() {
        const cat = document.getElementById('category').value;
        if (cat === 'SJ' || cat === 'ZX') return;
        const v1 = document.getElementById('cpu').value.trim();
        const v2 = document.getElementById('ram').value.trim();
        const v3 = document.getElementById('disk').value.trim();
        const v4 = document.getElementById('gpu').value.trim();
        const note = document.getElementById('note').value.trim();
        let parts = [];
        if (cat === 'PH' || cat === 'TB') {
            if(v1) parts.push(v1); if(v2) parts.push(v2); if(v3) parts.push(v3); if(v4) parts.push(v4); if(note) parts.push(note);
        } else if (cat === 'XS') {
            if(v1) parts.push(v1); if(v2) parts.push(v2); if(v3) parts.push(v3); if(v4) parts.push(v4); if(note) parts.push(note);
        } else {
            if(v1) parts.push(v1); if(v2) parts.push(v2); if(v3) parts.push(v3);
            if (v4) { parts.push(v4); } else if (v1) { parts.push("æ ¸æ˜¾ä¸»æœº"); }
            if(note) parts.push(note);
        }
        document.getElementById('name').value = parts.join(' '); 
    }

    function previewImage(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { document.getElementById('imgPreview').src = e.target.result; document.getElementById('imgPreview').classList.remove('hidden'); document.getElementById('uploadTip').classList.add('hidden'); }; reader.readAsDataURL(input.files[0]); } }
    
    window.showAddModal = () => document.getElementById('addModal').classList.remove('hidden');
    async function addContact() { const name = document.getElementById('newCName').value; if(!name) return alert('åç§°å¿…å¡«'); try { const res = await axios.post('/api/contacts/', { name, phone: document.getElementById('newCPhone').value, address: document.getElementById('newCAddr').value }); const sSelect = document.getElementById('supplier_id'); const opt = document.createElement('option'); opt.value = res.data.id; opt.text = res.data.name; opt.selected = true; sSelect.appendChild(opt); document.getElementById('addModal').classList.add('hidden'); } catch(e) { alert('æ·»åŠ å¤±è´¥'); } }
    
    async function submitForm() {
        const cat = document.getElementById('category').value;
        const name = document.getElementById('name').value;
        const cost = document.getElementById('cost').value;
        const sn = document.getElementById('sn').value.trim(); // ğŸŸ¢ è·å–åºåˆ—å·

        if(!name || !cost) return alert("è¯·å¡«å†™åç§°å’Œæˆæœ¬");
        // æ‰‹æœºå¹³æ¿å¿…é¡»å¡«SNï¼Œé˜²æ­¢è„æ•°æ®
        if((cat === 'PH' || cat === 'TB') && !sn) return alert("ğŸ“± æ‰‹æœº/å¹³æ¿ å¿…é¡»å¡«å†™ IMEI/åºåˆ—å·ï¼");
        
        const formData = new FormData();
        formData.append('supplier_id', document.getElementById('supplier_id').value);
        formData.append('category', cat);
        formData.append('name', name);
        formData.append('sn', sn); // ğŸŸ¢ å‘é€åºåˆ—å·
        formData.append('cost_price', cost);
        formData.append('paid_amount', document.getElementById('paid').value || 0);
        formData.append('account_id', document.getElementById('acc').value || '');
        formData.append('note', document.getElementById('note').value);
        formData.append('peer_price', document.getElementById('peer_price').value || 0);
        formData.append('retail_price', document.getElementById('retail_price').value || 0);
        formData.append('cpu', document.getElementById('cpu').value);
        formData.append('gpu', document.getElementById('gpu').value);
        formData.append('ram', document.getElementById('ram').value);
        formData.append('disk', document.getElementById('disk').value);
        
        const imgFile = document.getElementById('imageFile').files[0];
        if (imgFile) formData.append('image', imgFile);

        try {
            const res = await axios.post('/api/products/', formData, { headers: { 'Content-Type': 'multipart/form-data' } });
            document.getElementById('resZencode').innerText = res.data.zencode;
            document.getElementById('resName').innerText = res.data.name;
            document.getElementById('successModal').classList.remove('hidden');
        } catch(e) { alert("å…¥åº“å¤±è´¥: " + e); }
    }
</script>
{% endblock %}